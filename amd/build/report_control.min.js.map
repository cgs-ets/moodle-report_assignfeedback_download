{"version":3,"file":"report_control.min.js","sources":["../src/report_control.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\r\n/* eslint-disable require-jsdoc */\r\n/* eslint-disable jsdoc/require-jsdoc */\r\n// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n *\r\n * @package    report\r\n * @subpackage ibassessmentreport\r\n * @copyright  2021 Veronica Bermegui\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine([\"jquery\", \"core/ajax\", \"core/log\"/*, \"report_assignfeedback_download/html2pdf\"*/], function ($, Ajax, Log, /*html2pdf*/) {\r\n    \"use strict\";\r\n\r\n    function init() {\r\n        let userids = [];\r\n        let useritemids = [];\r\n        var control = new Controls(userids, useritemids);\r\n        control.main();\r\n    }\r\n\r\n    function Controls(userids, useritemids) {\r\n        let self = this;\r\n        self.userids = userids;\r\n        self.useritemids = useritemids;\r\n        self.frcollection = new Map();\r\n        self.indexFrubric = (Array.from(document.querySelector('td.rubric-cell').parentElement.cells)).indexOf(document.querySelector('td.rubric-cell'));\r\n        self.indexGrade = (Array.from(document.querySelector('td.grade-cell').parentElement.cells)).indexOf(document.querySelector('td.grade-cell'));\r\n        console.log(self.indexGrade);\r\n\r\n        $('.report-assignfeedback-downloading').toggle();\r\n\r\n    }\r\n\r\n    /**\r\n     * Run the controller.\r\n     *\r\n     */\r\n    Controls.prototype.main = function () {\r\n        let self = this;\r\n\r\n        self.selectbyone();\r\n        self.selectallaction();\r\n        //  self.rubricaction();  TODO: The  framework isnt downloading with the same style as the one in PHP. First version wont download\r\n\r\n        const instanceids = document\r\n            .querySelector(\"table.assignfeedback_download\")\r\n            .getAttribute(\"data-selected-assign\");\r\n        document\r\n            .getElementById(\"downloadactionform\")\r\n            .querySelector('input[name=\"instanceids\"]').value = instanceids;\r\n        const cmids = document\r\n            .querySelector(\"table.assignfeedback_download\")\r\n            .getAttribute(\"data-selected-cmid\");\r\n        document\r\n            .getElementById(\"downloadactionform\")\r\n            .querySelector('input[name=\"cmids\"]').value = cmids;\r\n\r\n\r\n        document.querySelector('.cant-download-btn').addEventListener('click', self.cantdownloadbuttonhandler);\r\n        //  self.downloadrubric();\r\n\r\n        //  document.getElementById(\"rubrictestdownload\").addEventListener(\"click\", self.downloadrubric);\r\n\r\n    };\r\n\r\n    Controls.prototype.cantdownloadbuttonhandler = function (e) {\r\n        if (document.querySelector('.alert-cant-download').style.display == 'none') {\r\n            document.querySelector('.alert-cant-download').style.display = 'block';\r\n        } else {\r\n            document.querySelector('.alert-cant-download').style.display = 'none';\r\n        }\r\n\r\n    }\r\n    Controls.prototype.selectbyone = function () {\r\n        let self = this;\r\n        let t = document.getElementById(\"iassignfeedbacktb\");\r\n        if (t) {\r\n            //  Collect all the users ids\r\n            Array.from(t.rows).forEach((tr) => {\r\n                const checkbox = tr.cells[0].firstChild;\r\n                checkbox.addEventListener(\r\n                    \"click\",\r\n                    self.selectbyonehandler.bind(self, this)\r\n                );\r\n            });\r\n        }\r\n    };\r\n\r\n    Controls.prototype.selectallaction = function () {\r\n        let self = this;\r\n        let selectall = document.getElementById(\"selectall\");\r\n        selectall.addEventListener(\"click\", self.selectallhandler.bind(self, this));\r\n    };\r\n\r\n    Controls.prototype.selectallhandler = function (s, e) {\r\n        let t = document.getElementById(\"iassignfeedbacktb\");\r\n        let countusers = 0;\r\n        const selectallcheckstatus = document.getElementById(\"selectall\").checked;\r\n\r\n        let form = document.getElementById(\"downloadactionform\");\r\n        let selectedusers = form.querySelector('input[name=\"selectedusers\"]');\r\n        let useritemids = form.querySelector('input[name=\"itemids\"]');\r\n        let frubricdetails = form.querySelector('input[name=\"frubricdetails\"]');\r\n\r\n\r\n        if (t) {\r\n            Array.from(t.rows).forEach((tr) => {\r\n                const checkbox = tr.cells[0].firstChild;\r\n                checkbox.checked = selectallcheckstatus;\r\n                const users = checkbox.getAttribute(\"id\").split(\"_\");\r\n                const userid = users[users.length - 1];\r\n                const innertable = document.getElementById(`innertable_${userid}`);\r\n                const uitemids = innertable\r\n                    .getAttribute(\"data-user-grade-id\")\r\n                    .split(\",\");\r\n                uitemids.pop(); // Remove the last empty item.\r\n                const usersummary = {\r\n                    userid: userid,\r\n                    uitemids: uitemids,\r\n\r\n                };\r\n\r\n                s.useritemids.push(usersummary);\r\n                countusers++;\r\n\r\n                if (!checkbox.checked && s.userids.includes(userid)) {\r\n                    const index = s.userids.indexOf(userid);\r\n                    if (index > -1) {\r\n                        s.userids.splice(index, 1);\r\n                        const aux = s.useritemids;\r\n\r\n                        s.useritemids = aux.filter(function (el) {\r\n                            if (el.userid != userid) {\r\n                                return el;\r\n                            }\r\n                        }, userid);\r\n                        // Remove from Frubric\r\n                        s.frcollection.delete(userid);\r\n                        frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\r\n                    }\r\n\r\n                } else if (checkbox.checked && !s.userids.includes(userid)) {\r\n                    s.userids.push(users[users.length - 1]);\r\n                    // Check FRubric\r\n                    const innertabletr = document.getElementById(`innertable_${userid}`).querySelector('tbody');\r\n                    for (let i = 0; i < innertabletr.rows.length; i++) {\r\n                        if (innertabletr.rows[i].cells[s.indexFrubric].children.length > 0) { // It has  a rubric\r\n                            if (!s.frcollection.has(userid)) {\r\n                                s.frcollection.set(userid, []);\r\n                            }\r\n                            const frcontainer = innertabletr.rows[i].cells[s.indexFrubric].firstElementChild;\r\n                            s.frcollection.get(userid).push(frcontainer.getAttribute('data-frubric-params'));\r\n\r\n                            // Check if the rubric will be able to download\r\n                            //alert-cant-download\r\n                            const gradecontainer = innertabletr.rows[i].cells[s.indexGrade];\r\n\r\n                            if (gradecontainer.getAttribute('data-candownload') == 0) {\r\n                                document.querySelector('.alert-cant-download').style.display = 'block'\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\r\n                }\r\n\r\n\r\n            });\r\n\r\n            if (!selectallcheckstatus) {\r\n                s.userids = []; // Clear the array.\r\n            }\r\n\r\n            if (countusers == s.userids.length) {\r\n                (document.getElementById(\"id_operation\").children[0]).disabled = false;\r\n            } else {\r\n                (document.getElementById(\"id_operation\").children[0]).disabled = true;\r\n            }\r\n\r\n        }\r\n\r\n        selectedusers.value = s.userids;\r\n        useritemids.value = JSON.stringify(s.useritemids);\r\n\r\n        // Enable the download select only if there are selected users.\r\n        if (selectedusers.value) {\r\n            document.getElementById(\"id_operation\").disabled = false;\r\n            document.getElementById(\"id_submit\").disabled = false;\r\n        } else {\r\n            document.getElementById(\"id_operation\").disabled = true;\r\n            document.getElementById(\"id_submit\").disabled = true;\r\n        }\r\n    };\r\n\r\n    Controls.prototype.selectbyonehandler = function (s, e) {\r\n        console.log(\"selectbyonehandler\");\r\n        let userid = e.target.id;\r\n        userid = userid.split(\"_\");\r\n        userid = userid[userid.length - 1];\r\n        const innertable = document.getElementById(`innertable_${userid}`);\r\n        const uitemids = innertable.getAttribute(\"data-user-grade-id\").split(\",\");\r\n        uitemids.pop(); // Remove the last empty item.\r\n        const usersummary = {\r\n            userid: userid,\r\n            uitemids: uitemids\r\n        };\r\n\r\n        s.useritemids.push(usersummary);\r\n        const selectedall = document.getElementById(\"selectall\");\r\n\r\n        let form = document.getElementById(\"downloadactionform\");\r\n        let frubricdetails = form.querySelector('input[name=\"frubricdetails\"]');\r\n\r\n        if (selectedall.checked) {\r\n            document.getElementById(\"selectall\").checked = false;\r\n        }\r\n\r\n        if (!e.target.checked && s.userids.includes(userid)) {\r\n            const index = s.userids.indexOf(userid);\r\n            if (index > -1) {\r\n                s.userids.splice(index, 1);\r\n                const aux = s.useritemids;\r\n                s.useritemids = aux.filter(function (el) {\r\n                    if (el.userid != userid) {\r\n                        return el;\r\n                    }\r\n                }, userid);\r\n                console.log(s.frcollection);\r\n                // Remove from Frubric\r\n                s.frcollection.delete(userid);\r\n                frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\r\n            }\r\n        } else {\r\n            s.userids.push(userid);\r\n            // Check FRubric\r\n            for (let i = 0; i < innertable.rows.length; i++) {\r\n                if (innertable.rows[i].cells[s.indexFrubric].children.length > 0) { // It has  a rubric\r\n                    if (!s.frcollection.has(userid)) {\r\n                        s.frcollection.set(userid, []);\r\n                    }\r\n                    const frcontainer = innertable.rows[i].cells[s.indexFrubric].firstElementChild;\r\n                    s.frcollection.get(userid).push(frcontainer.getAttribute('data-frubric-params'));\r\n\r\n                    // Check if the rubric will be able to download\r\n                    //alert-cant-download\r\n                    const gradecontainer = innertable.rows[i].cells[s.indexGrade];\r\n                    if (gradecontainer.getAttribute('data-candownload') == 0) {\r\n                        document.querySelector('.alert-cant-download').style.display = 'block'\r\n                    }\r\n                }\r\n            }\r\n\r\n\r\n            frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\r\n        }\r\n\r\n\r\n        let selectedusers = form.querySelector('input[name=\"selectedusers\"]');\r\n        let useritemids = form.querySelector('input[name=\"itemids\"]');\r\n        selectedusers.value = s.userids;\r\n        useritemids.value = JSON.stringify(s.useritemids);\r\n\r\n\r\n        if (selectedusers.value) {\r\n            document.getElementById(\"id_operation\").disabled = false;\r\n            document.getElementById(\"id_submit\").disabled = false;\r\n        } else {\r\n            document.getElementById(\"id_operation\").disabled = true;\r\n            document.getElementById(\"id_submit\").disabled = true;\r\n        }\r\n    };\r\n\r\n    // Controls.prototype.rubricaction = function () {\r\n    //     Y.log('rubricaction');\r\n    //     const self = this;\r\n    //     let t = document.getElementById(\"iassignfeedbacktb\");\r\n\r\n    //     if (t) {\r\n\r\n    //         Array.from(t.rows).forEach((tr) => {\r\n    //             const checkbox = tr.cells[0].firstChild;\r\n    //             const user = checkbox.getAttribute(\"id\").split(\"_\");\r\n    //             const userid = user[user.length - 1];\r\n    //             const innertabletr = document.getElementById(`innertable_${userid}`).querySelector('tbody');\r\n\r\n    //             for (let i = 0; i < innertabletr.rows.length; i++) {\r\n    //                 if (innertabletr.rows[i].cells[5].children.length > 0) { // It has  a rubric\r\n    //                     const frcontainer = innertabletr.rows[i].cells[5].firstElementChild;\r\n    //                     frcontainer.addEventListener('click', self.downloadrubric);\r\n\r\n    //                 }\r\n    //             }\r\n    //         }, self);\r\n    //     }\r\n    // }\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"names":["define","$","Ajax","Log","Controls","userids","useritemids","this","frcollection","Map","indexFrubric","Array","from","document","querySelector","parentElement","cells","indexOf","indexGrade","console","log","toggle","prototype","main","selectbyone","selectallaction","instanceids","getAttribute","getElementById","value","cmids","addEventListener","cantdownloadbuttonhandler","e","style","display","self","t","rows","forEach","tr","firstChild","selectbyonehandler","bind","selectallhandler","s","countusers","selectallcheckstatus","checked","form","selectedusers","frubricdetails","checkbox","users","split","userid","length","uitemids","pop","usersummary","push","includes","index","splice","aux","filter","el","delete","JSON","stringify","Object","fromEntries","innertabletr","i","children","has","set","frcontainer","firstElementChild","get","disabled","target","id","innertable","selectedall","init"],"mappings":"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"}