{"version":3,"file":"report_control.min.js","sources":["../src/report_control.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\n/* eslint-disable require-jsdoc */\n/* eslint-disable jsdoc/require-jsdoc */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *\n * @package    report\n * @subpackage ibassessmentreport\n * @copyright  2021 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\"jquery\", \"core/ajax\", \"core/log\", \"report_assignfeedback_download/html2pdf\"], function ($, Ajax, Log, html2pdf) {\n    \"use strict\";\n\n    function init() {\n        let userids = [];\n        let useritemids = [];\n        var control = new Controls(userids, useritemids);\n        control.main();\n    }\n\n    function Controls(userids, useritemids) {\n        let self = this;\n        self.userids = userids;\n        self.useritemids = useritemids;\n        self.frcollection = new Map();\n        self.indexFrubric = (Array.from(document.querySelector('td.rubric-cell').parentElement.cells)).indexOf(document.querySelector('td.rubric-cell'));\n        self.indexGrade = (Array.from(document.querySelector('td.grade-cell').parentElement.cells)).indexOf(document.querySelector('td.grade-cell'));\n        console.log(self.indexGrade);\n\n\n    }\n\n    /**\n     * Run the controller.\n     *\n     */\n    Controls.prototype.main = function () {\n        let self = this;\n\n        self.selectbyone();\n        self.selectallaction();\n        //  self.rubricaction();  TODO: The  framework isnt downloading with the same style as the one in PHP. First version wont download\n\n        const instanceids = document\n            .querySelector(\"table.assignfeedback_download\")\n            .getAttribute(\"data-selected-assign\");\n        document\n            .getElementById(\"downloadactionform\")\n            .querySelector('input[name=\"instanceids\"]').value = instanceids;\n        const cmids = document\n            .querySelector(\"table.assignfeedback_download\")\n            .getAttribute(\"data-selected-cmid\");\n        document\n            .getElementById(\"downloadactionform\")\n            .querySelector('input[name=\"cmids\"]').value = cmids;\n\n\n        document.querySelector('.cant-download-btn').addEventListener('click', self.cantdownloadbuttonhandler)\n        //  self.downloadrubric();\n\n        //  document.getElementById(\"rubrictestdownload\").addEventListener(\"click\", self.downloadrubric);\n\n    };\n\n    Controls.prototype.cantdownloadbuttonhandler = function (e) {\n        if (document.querySelector('.alert-cant-download').style.display == 'none') {\n            document.querySelector('.alert-cant-download').style.display = 'block';\n        } else {\n            document.querySelector('.alert-cant-download').style.display = 'none';\n        }\n\n    }\n    Controls.prototype.selectbyone = function () {\n        let self = this;\n        let t = document.getElementById(\"iassignfeedbacktb\");\n        if (t) {\n            //  Collect all the users ids\n            Array.from(t.rows).forEach((tr) => {\n                const checkbox = tr.cells[0].firstChild;\n                checkbox.addEventListener(\n                    \"click\",\n                    self.selectbyonehandler.bind(self, this)\n                );\n            });\n        }\n    };\n\n    Controls.prototype.selectallaction = function () {\n        let self = this;\n        let selectall = document.getElementById(\"selectall\");\n        selectall.addEventListener(\"click\", self.selectallhandler.bind(self, this));\n    };\n\n    Controls.prototype.selectallhandler = function (s, e) {\n        let t = document.getElementById(\"iassignfeedbacktb\");\n        let countusers = 0;\n        const selectallcheckstatus = document.getElementById(\"selectall\").checked;\n\n        let form = document.getElementById(\"downloadactionform\");\n        let selectedusers = form.querySelector('input[name=\"selectedusers\"]');\n        let useritemids = form.querySelector('input[name=\"itemids\"]');\n        let frubricdetails = form.querySelector('input[name=\"frubricdetails\"]');\n\n\n        if (t) {\n            Array.from(t.rows).forEach((tr) => {\n                const checkbox = tr.cells[0].firstChild;\n                checkbox.checked = selectallcheckstatus;\n                const users = checkbox.getAttribute(\"id\").split(\"_\");\n                const userid = users[users.length - 1];\n                const innertable = document.getElementById(`innertable_${userid}`);\n                const uitemids = innertable\n                    .getAttribute(\"data-user-grade-id\")\n                    .split(\",\");\n                uitemids.pop(); // Remove the last empty item.\n                const usersummary = {\n                    userid: userid,\n                    uitemids: uitemids,\n\n                };\n\n                s.useritemids.push(usersummary);\n                countusers++;\n\n                if (!checkbox.checked && s.userids.includes(userid)) {\n                    const index = s.userids.indexOf(userid);\n                    if (index > -1) {\n                        s.userids.splice(index, 1);\n                        const aux = s.useritemids;\n\n                        s.useritemids = aux.filter(function (el) {\n                            if (el.userid != userid) {\n                                return el;\n                            }\n                        }, userid);\n                        // Remove from Frubric\n                        s.frcollection.delete(userid);\n                        frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\n                    }\n\n                } else if (checkbox.checked && !s.userids.includes(userid)) {\n                    s.userids.push(users[users.length - 1]);\n                    // Check FRubric\n                    const innertabletr = document.getElementById(`innertable_${userid}`).querySelector('tbody');\n                    for (let i = 0; i < innertabletr.rows.length; i++) {\n                        if (innertabletr.rows[i].cells[s.indexFrubric].children.length > 0) { // It has  a rubric\n                            if (!s.frcollection.has(userid)) {\n                                s.frcollection.set(userid, []);\n                            }\n                            const frcontainer = innertabletr.rows[i].cells[s.indexFrubric].firstElementChild;\n                            s.frcollection.get(userid).push(frcontainer.getAttribute('data-frubric-params'));\n\n                            // Check if the rubric will be able to download\n                            //alert-cant-download\n                            const gradecontainer = innertabletr.rows[i].cells[s.indexGrade];\n\n                            if (gradecontainer.getAttribute('data-candownload') == 0) {\n                                document.querySelector('.alert-cant-download').style.display = 'block'\n                            }\n                        }\n                    }\n\n                    frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\n                }\n\n\n            });\n\n            if (!selectallcheckstatus) {\n                s.userids = []; // Clear the array.\n            }\n\n            if (countusers == s.userids.length) {\n                (document.getElementById(\"id_operation\").children[0]).disabled = false;\n            } else {\n                (document.getElementById(\"id_operation\").children[0]).disabled = true;\n            }\n\n        }\n\n        selectedusers.value = s.userids;\n        useritemids.value = JSON.stringify(s.useritemids);\n\n        // Enable the download select only if there are selected users.\n        if (selectedusers.value) {\n            document.getElementById(\"id_operation\").disabled = false;\n            document.getElementById(\"id_submit\").disabled = false;\n        } else {\n            document.getElementById(\"id_operation\").disabled = true;\n            document.getElementById(\"id_submit\").disabled = true;\n        }\n    };\n\n    Controls.prototype.selectbyonehandler = function (s, e) {\n        console.log(\"selectbyonehandler\");\n        let userid = e.target.id;\n        userid = userid.split(\"_\");\n        userid = userid[userid.length - 1];\n        const innertable = document.getElementById(`innertable_${userid}`);\n        const uitemids = innertable.getAttribute(\"data-user-grade-id\").split(\",\");\n        uitemids.pop(); // Remove the last empty item.\n        const usersummary = {\n            userid: userid,\n            uitemids: uitemids\n        };\n\n        s.useritemids.push(usersummary);\n        const selectedall = document.getElementById(\"selectall\");\n\n        let form = document.getElementById(\"downloadactionform\");\n        let frubricdetails = form.querySelector('input[name=\"frubricdetails\"]');\n\n        if (selectedall.checked) {\n            document.getElementById(\"selectall\").checked = false;\n        }\n\n        if (!e.target.checked && s.userids.includes(userid)) {\n            const index = s.userids.indexOf(userid);\n            if (index > -1) {\n                s.userids.splice(index, 1);\n                const aux = s.useritemids;\n                s.useritemids = aux.filter(function (el) {\n                    if (el.userid != userid) {\n                        return el;\n                    }\n                }, userid);\n                console.log(s.frcollection);\n                // Remove from Frubric\n                s.frcollection.delete(userid);\n                frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\n            }\n        } else {\n            s.userids.push(userid);\n            // Check FRubric\n            for (let i = 0; i < innertable.rows.length; i++) {\n                if (innertable.rows[i].cells[s.indexFrubric].children.length > 0) { // It has  a rubric\n                    if (!s.frcollection.has(userid)) {\n                        s.frcollection.set(userid, []);\n                    }\n                    const frcontainer = innertable.rows[i].cells[s.indexFrubric].firstElementChild;\n                    s.frcollection.get(userid).push(frcontainer.getAttribute('data-frubric-params'));\n\n                    // Check if the rubric will be able to download\n                    //alert-cant-download\n                    const gradecontainer = innertable.rows[i].cells[s.indexGrade];\n                    if (gradecontainer.getAttribute('data-candownload') == 0) {\n                        document.querySelector('.alert-cant-download').style.display = 'block'\n                    }\n                }\n            }\n\n\n            frubricdetails.value = JSON.stringify(Object.fromEntries(s.frcollection));\n        }\n\n\n        let selectedusers = form.querySelector('input[name=\"selectedusers\"]');\n        let useritemids = form.querySelector('input[name=\"itemids\"]');\n        selectedusers.value = s.userids;\n        useritemids.value = JSON.stringify(s.useritemids);\n\n\n        if (selectedusers.value) {\n            document.getElementById(\"id_operation\").disabled = false;\n            document.getElementById(\"id_submit\").disabled = false;\n        } else {\n            document.getElementById(\"id_operation\").disabled = true;\n            document.getElementById(\"id_submit\").disabled = true;\n        }\n    };\n\n    // Controls.prototype.rubricaction = function () {\n    //     Y.log('rubricaction');\n    //     const self = this;\n    //     let t = document.getElementById(\"iassignfeedbacktb\");\n\n    //     if (t) {\n\n    //         Array.from(t.rows).forEach((tr) => {\n    //             const checkbox = tr.cells[0].firstChild;\n    //             const user = checkbox.getAttribute(\"id\").split(\"_\");\n    //             const userid = user[user.length - 1];\n    //             const innertabletr = document.getElementById(`innertable_${userid}`).querySelector('tbody');\n\n    //             for (let i = 0; i < innertabletr.rows.length; i++) {\n    //                 if (innertabletr.rows[i].cells[5].children.length > 0) { // It has  a rubric\n    //                     const frcontainer = innertabletr.rows[i].cells[5].firstElementChild;\n    //                     frcontainer.addEventListener('click', self.downloadrubric);\n\n    //                 }\n    //             }\n    //         }, self);\n    //     }\n    // }\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Ajax","Log","html2pdf","Controls","userids","useritemids","this","frcollection","Map","indexFrubric","Array","from","document","querySelector","parentElement","cells","indexOf","indexGrade","console","log","prototype","main","selectbyone","selectallaction","instanceids","getAttribute","getElementById","value","cmids","addEventListener","cantdownloadbuttonhandler","e","style","display","self","t","rows","forEach","tr","firstChild","selectbyonehandler","bind","_this","selectallhandler","s","countusers","selectallcheckstatus","checked","form","selectedusers","frubricdetails","checkbox","users","split","userid","length","uitemids","pop","usersummary","push","includes","index","splice","aux","filter","el","delete","JSON","stringify","Object","fromEntries","innertabletr","i","children","has","set","frcontainer","firstElementChild","get","disabled","target","id","innertable","selectedall","init"],"mappings":"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"}