/**
 *
 * @package    report
 * @subpackage ibassessmentreport
 * @copyright  2021 Veronica Bermegui
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_assignfeedback_download/report_control",["jquery","core/ajax","core/log"],(function($,Ajax,Log){function Controls(userids,useritemids){this.userids=userids,this.useritemids=useritemids,this.frcollection=new Map,this.indexFrubric=Array.from(document.querySelector("td.rubric-cell").parentElement.cells).indexOf(document.querySelector("td.rubric-cell")),this.indexGrade=Array.from(document.querySelector("td.grade-cell").parentElement.cells).indexOf(document.querySelector("td.grade-cell")),console.log(this.indexGrade),$(".report-assignfeedback-downloading").toggle()}return Controls.prototype.main=function(){this.selectbyone(),this.selectallaction();const instanceids=document.querySelector("table.assignfeedback_download").getAttribute("data-selected-assign");document.getElementById("downloadactionform").querySelector('input[name="instanceids"]').value=instanceids;const cmids=document.querySelector("table.assignfeedback_download").getAttribute("data-selected-cmid");document.getElementById("downloadactionform").querySelector('input[name="cmids"]').value=cmids,document.querySelector(".cant-download-btn").addEventListener("click",this.cantdownloadbuttonhandler)},Controls.prototype.cantdownloadbuttonhandler=function(e){"none"==document.querySelector(".alert-cant-download").style.display?document.querySelector(".alert-cant-download").style.display="block":document.querySelector(".alert-cant-download").style.display="none"},Controls.prototype.selectbyone=function(){let self=this,t=document.getElementById("iassignfeedbacktb");t&&Array.from(t.rows).forEach((tr=>{tr.cells[0].firstChild.addEventListener("click",self.selectbyonehandler.bind(self,this))}))},Controls.prototype.selectallaction=function(){document.getElementById("selectall").addEventListener("click",this.selectallhandler.bind(this,this))},Controls.prototype.selectallhandler=function(s,e){let t=document.getElementById("iassignfeedbacktb"),countusers=0;const selectallcheckstatus=document.getElementById("selectall").checked;let form=document.getElementById("downloadactionform"),selectedusers=form.querySelector('input[name="selectedusers"]'),useritemids=form.querySelector('input[name="itemids"]'),frubricdetails=form.querySelector('input[name="frubricdetails"]');t&&(Array.from(t.rows).forEach((tr=>{const checkbox=tr.cells[0].firstChild;checkbox.checked=selectallcheckstatus;const users=checkbox.getAttribute("id").split("_"),userid=users[users.length-1],uitemids=document.getElementById(`innertable_${userid}`).getAttribute("data-user-grade-id").split(",");uitemids.pop();const usersummary={userid:userid,uitemids:uitemids};if(s.useritemids.push(usersummary),countusers++,!checkbox.checked&&s.userids.includes(userid)){const index=s.userids.indexOf(userid);if(index>-1){s.userids.splice(index,1);const aux=s.useritemids;s.useritemids=aux.filter((function(el){if(el.userid!=userid)return el}),userid),s.frcollection.delete(userid),frubricdetails.value=JSON.stringify(Object.fromEntries(s.frcollection))}}else if(checkbox.checked&&!s.userids.includes(userid)){s.userids.push(users[users.length-1]);const innertabletr=document.getElementById(`innertable_${userid}`).querySelector("tbody");for(let i=0;i<innertabletr.rows.length;i++)if(innertabletr.rows[i].cells[s.indexFrubric].children.length>0){s.frcollection.has(userid)||s.frcollection.set(userid,[]);const frcontainer=innertabletr.rows[i].cells[s.indexFrubric].firstElementChild;s.frcollection.get(userid).push(frcontainer.getAttribute("data-frubric-params"));0==innertabletr.rows[i].cells[s.indexGrade].getAttribute("data-candownload")&&(document.querySelector(".alert-cant-download").style.display="block")}frubricdetails.value=JSON.stringify(Object.fromEntries(s.frcollection))}})),selectallcheckstatus||(s.userids=[]),countusers==s.userids.length?document.getElementById("id_operation").children[0].disabled=!1:document.getElementById("id_operation").children[0].disabled=!0),selectedusers.value=s.userids,useritemids.value=JSON.stringify(s.useritemids),selectedusers.value?(document.getElementById("id_operation").disabled=!1,document.getElementById("id_submit").disabled=!1):(document.getElementById("id_operation").disabled=!0,document.getElementById("id_submit").disabled=!0)},Controls.prototype.selectbyonehandler=function(s,e){console.log("selectbyonehandler");let userid=e.target.id;userid=userid.split("_"),userid=userid[userid.length-1];const innertable=document.getElementById(`innertable_${userid}`),uitemids=innertable.getAttribute("data-user-grade-id").split(",");uitemids.pop();const usersummary={userid:userid,uitemids:uitemids};s.useritemids.push(usersummary);const selectedall=document.getElementById("selectall");let form=document.getElementById("downloadactionform"),frubricdetails=form.querySelector('input[name="frubricdetails"]');if(selectedall.checked&&(document.getElementById("selectall").checked=!1),!e.target.checked&&s.userids.includes(userid)){const index=s.userids.indexOf(userid);if(index>-1){s.userids.splice(index,1);const aux=s.useritemids;s.useritemids=aux.filter((function(el){if(el.userid!=userid)return el}),userid),console.log(s.frcollection),s.frcollection.delete(userid),frubricdetails.value=JSON.stringify(Object.fromEntries(s.frcollection))}}else{s.userids.push(userid);for(let i=0;i<innertable.rows.length;i++)if(innertable.rows[i].cells[s.indexFrubric].children.length>0){s.frcollection.has(userid)||s.frcollection.set(userid,[]);const frcontainer=innertable.rows[i].cells[s.indexFrubric].firstElementChild;s.frcollection.get(userid).push(frcontainer.getAttribute("data-frubric-params"));0==innertable.rows[i].cells[s.indexGrade].getAttribute("data-candownload")&&(document.querySelector(".alert-cant-download").style.display="block")}frubricdetails.value=JSON.stringify(Object.fromEntries(s.frcollection))}let selectedusers=form.querySelector('input[name="selectedusers"]'),useritemids=form.querySelector('input[name="itemids"]');selectedusers.value=s.userids,useritemids.value=JSON.stringify(s.useritemids),selectedusers.value?(document.getElementById("id_operation").disabled=!1,document.getElementById("id_submit").disabled=!1):(document.getElementById("id_operation").disabled=!0,document.getElementById("id_submit").disabled=!0)},{init:function(){new Controls([],[]).main()}}}));

//# sourceMappingURL=report_control.min.js.map